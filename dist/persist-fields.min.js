(function(){function t(e){if(e=="queryStorage"||e=="fragmentStorage"||e=="cookieStorage"||e=="httpStorage"){return true}let t;try{t=window[e];const n="__storage_test__";t.setItem(n,n);t.removeItem(n);return true}catch(e){return e instanceof DOMException&&(e.code===22||e.code===1014||e.name==="QuotaExceededError"||e.name==="NS_ERROR_DOM_QUOTA_REACHED")&&t&&t.length!==0}}function l(e){if(X&&console.log){console.log((new Date).toISOString(),e)}}function s(e){return(e===undefined?"":Array.isArray(e)?e.join(""):e.toString()).replaceAll("%2C",",").replaceAll("%3A",":").replaceAll("%2F","/")}function a(e,t,n){return n.indexOf(e)===t}function d(e){return e.type==="checkbox"||e.type==="radio"}function o(e,t){let n=t==e.getAttribute("name")||t==e.getAttribute("persist-fields-name")?[e]:[];return n.concat([...e.querySelectorAll('[name="'+t+'"'),...e.querySelectorAll('[persist-fields-name="'+t+'"]')])}function c(e){return d(e)?[e.checked]:e.tagName==="SELECT"?[...e.selectedOptions].map(e=>e.value):e.tagName==="INPUT"||e.tagName==="TEXTAREA"?[e.value]:[e.innerText]}function e(e){return d(e)?[e.defaultChecked]:e.tagName==="SELECT"?[...e.options].filter(e=>e.defaultSelected).map(e=>e.value):e.tagName==="INPUT"||e.tagName==="TEXTAREA"?[e.defaultValue]:[e.innerText]}function g(e,t,n){let i=o(e,t).filter(e=>!e.closest(":disabled"));let r=i.filter(d).filter(e=>n(e)[0]).map(e=>e.value).join(",");let l=i.filter(e=>!d(e));for(let e=l.length-1;e>=0;e--){if(JSON.stringify(n(l[e]))==='[""]'||l[e].hasAttribute("readonly")&&!l[e].hasAttribute("required")&&(e>0&&JSON.stringify(n(l[e-1]))==='[""]'||e==l.length-1)){l.splice(e,1)}}return[r].filter(e=>e!="").concat(l.map(n))}function u(e){if(["INPUT","TEXTAREA","SELECT"].includes(e.tagName)&&e.hasAttribute("name")||e.hasAttribute("persist-fields-name")){return[e]}else{var n=[];e.querySelectorAll("input[name], textarea[name], select[name], [persist-fields-name]").forEach(t=>{L.withExtensions(t,function(e){if(e._ext_persist_fields){n.push(t)}})});return n}}function i(n,e,i){if(typeof n==="number"){var t=(i.trim().length==0?[]:i.split(e)).map(decodeURIComponent);return n<t.length?[t[n]]:undefined}else if(typeof n==="string"){let e=new URLSearchParams(i);let t=e.has(n)?e.getAll(n):undefined;return Array.isArray(t)&&t.length==1&&t[0]===""?[]:t}else{throw new Error("Invalid storageKey")}}function h(e,t,n){l("readStorage("+e+", "+t+", "+n+")");if(e=="query"){n(i(t,"&",window.location.search.substring(1)))}else if(e=="fragment"){n(i(t,"#",window.location.hash.substring(1)))}else if(e=="cookie"){let e=document.cookie.split("; ").filter(e=>e.length>0).map(e=>{let t=e.split("=");let n={};n[t[0]]=t[1]===undefined?undefined:decodeURIComponent(t[1]).split(",");return n}).reduce((e,t)=>Object.assign(e,t),{});n(t?e[t]?e[t]:undefined:document.cookie.length==0?undefined:e)}else if(e=="session"){n(JSON.parse(sessionStorage.getItem(t))||{})}else if(e=="local"){n(JSON.parse(localStorage.getItem(t))||{})}else if(e=="http"){let e=new XMLHttpRequest;e.open("GET",t);e.onload=()=>{n(JSON.parse(e.responseText))};e.send()}}function r(n,e,i,r){if(typeof n==="number"){const t=i.substring(1).split(e);while(t.length<=n){t.push("")}t[n]=s(r);return t.join(e).replace(new RegExp(e+"+$"),"")}else{let t=new URLSearchParams(i.substring(1));t.delete(n);if(r===undefined){}else if(r.length==0){t.append(n,"")}else{r.forEach(e=>Array.isArray(e)?e.forEach(e=>t.append(n,s(e))):t.append(n,s(e)))}return s(t)}}function p(e,t,n,i){l("saveStorage("+e+", "+t+", "+n+", "+i+")");if(e==="query"){let e=r(n,"&",window.location.search,t);if(e!==window.location.search.substring(1)){history.replaceState(null,null,window.location.protocol+"//"+window.location.host+window.location.pathname+"?"+e+window.location.hash)}}else if(e==="fragment"){let e=r(n,"#",window.location.hash,t);if(e!==window.location.hash.substring(1)){history.replaceState(null,null,window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search+"#"+e)}}else if(e==="cookie"){if(t){document.cookie=n+"="+encodeURIComponent(t.join(","))+";"+i}else{document.cookie=n+"=;max-age=0"}}else if(e==="session"){if(t===undefined){sessionStorage.removeItem(n)}else{sessionStorage.setItem(n,JSON.stringify(t))}}else if(e==="local"){if(t===undefined){localStorage.removeItem(n)}else{localStorage.setItem(n,JSON.stringify(t))}}else if(e==="http"){let e=new XMLHttpRequest;if(t===undefined){e.open("DELETE",n);e.send()}else{e.open("PUT",n);e.send(JSON.stringify(t))}}}function m(e,t){if(t){if(t.delete){t.delete(e)}else if(t[e]!==undefined){delete t[e]}}return t}function f(e,t,n){l("clear("+e+", "+t+", "+n+")");h(e,n,()=>{if(t){t.querySelectorAll("[data-persist-fields-initialized]").forEach(e=>{if(d(e)){e.checked=e.getAttribute("data-persist-fields-initialized")==="true"}else{e.value=e.getAttribute("data-persist-fields-initialized")}})}p(e,undefined,n)})}function A(n,i){n.selectedIndex=-1;[...n.options].filter(e=>e.value).forEach(e=>{let t=i.includes(e.value);if(t&&!n.multiple&&[...n.selectedOptions].filter(e=>e.value).length>0){n.multiple=true}if(e.selected!==t){l("Changing "+e.value+" of "+(n.id||n.name)+" to "+t);e.selected=t}});if([...n.selectedOptions].filter(e=>e.value).length==0){l("Selecting defaults of "+(n.id||n.name));[...n.selectedOptions].filter(e=>e.defaultSelected).filter(e=>!e.selected).forEach(e=>e.selected=true)}}function n(e,i,t,r){l("setValue("+e+", "+i+", "+t+", "+r+")");if(r!==undefined){if(d(i)){i.checked=r.flatMap(e=>e.split(",")).includes(i.value)}else{let n=o(e,t);if(n.length===1){if(i.tagName==="INPUT"||i.tagName==="TEXTAREA"){i.value=r.join("")}else if(i.tagName==="SELECT"){let e=(Array.isArray(r)?r:[r]).flatMap(e=>e.split(","));A(i,e)}else{i.innerText=r.join("")}}else{let e=n.indexOf(i);let t=J(n,r,e);if(t!==undefined){if(i.tagName==="INPUT"||i.tagName==="TEXTAREA"){i.value=t}else if(i.tagName==="SELECT"){let e=Array.isArray(t)?t:[t];A(i,e)}else{i.innerText=t}}}}}}function b(t,n){if(n.hasAttribute("readonly")){if(t.startsWith(n.getAttribute("value"))){let e=n.getAttribute("value");return[e,t.substring(e.length)]}}return undefined}function E(t,n){if(n.hasAttribute("minlength")&&n.getAttribute("minlength")===n.getAttribute("maxlength")){let e=t.substring(0,parseInt(n.getAttribute("minlength")));return[e,t.substring(e.length)]}return undefined}function S(t,n,i,r){let l=n.match(t);if(i.length<r&&l!==null&&l[0].length>0){let e=l.length>1?l[1]:l[0];return S(t,n.substring(l[0].length),[...i,e],r)}return[i,n]}function w(n,i){if(i.hasAttribute("pattern")){let e=i.getAttribute("pattern");let t=S(new RegExp(e.startsWith("^")?e:"^"+e),n,[],1);if(t[0].length>0){return t[0].length>=1?[t[0][0],t[1]]:t}}return undefined}function y(n,e){if(e.getAttribute("type")==="datetime-local"){let t=n.match(/^[0-9]{1,4}-[0-9]{2}-[0-9]{2}[T ][0-9]{2}:[0-9]{2}/);if(t!==null){let e=t[0];return[e,n.substring(e.length)]}}return undefined}function x(n,e){if(e.getAttribute("type")==="date"){let t=n.match(/^[0-9]{1,4}-[0-9]{2}-[0-9]{2}/);if(t!==null){let e=t[0];return[e,n.substring(e.length)]}}return undefined}function T(n,e){if(e.getAttribute("type")==="time"){let t=n.match(/^[0-9]{2}:[0-9]{2}(:[0-9]{2})?/);if(t!==null){let e=t[0];return[e,n.substring(e.length)]}}return undefined}function N(t,n){if(n.tagName==="SELECT"){let e=[...n.options].map(e=>e.value).filter(e=>e!=="").filter(e=>t.startsWith(e)).sort((e,t)=>t.length-e.length).find(e=>true);if(e){return[e,t.substring(e.length)]}}return undefined}function v(t,n,i){let r=[...t.options].map(e=>e.value).filter(e=>e!=="").filter(e=>n.startsWith(e)).sort((e,t)=>t.length-e.length).find(e=>true);if(r){let e=n.substring(r.length);if(e.startsWith(",")){return v(t,e.substring(1),[...i,r])}return[[...i,r],e]}return[i,n]}function I(t,n){if(n.tagName==="SELECT"&&n.multiple){let e=v(n,t,[]);if(e[0].length>0){return e}}return undefined}function O(e,t){if((t.tagName==="TEXTAREA"||t.tagName==="INPUT"&&["text","hidden"].includes(t.type))&&(!t.hasAttribute("minlength")||parseInt(t.getAttribute("minlength"))<=e.length)&&(!t.hasAttribute("maxlength")||parseInt(t.getAttribute("maxlength"))>=e.length)){return[e,""]}return undefined}function R(n,i){for(let t in U){let e=U[t](n,i);if(e!==undefined){l("Matched "+e[0]+" of "+n+" in "+(i.id||i.name)+" with matcher "+U[t].name);return e}}return[undefined,n]}function J(n,i,r){if(i.length==0){return""}else if(i.length>1){return i[r]}else{let[e,t]=n.slice(0,r+1).reduce(([e,t],n)=>R(t,n),[undefined,i[0]]);return e}}function C(e){return e.getAttribute("name")||e.getAttribute("persist-fields-name")}function _(e,t,n){return e==="cookie"?t:e==="http"?n:n!==undefined?n:t}function P(i,r,l,s){let a=C(l);let o=_(r,a,s);let u=r==="local"||r==="session"||r==="http";let f=g(i,a,e);if(l.hasAttribute("readonly")&&!d(l)&&l.defaultValue){}else{h(r,o,e=>{n(i,l,a,u?e[a]:e)})}window.addEventListener("htmx:persistFieldsSave",e=>{if(e.detail.scope!==i){h(r,o,e=>{n(i,l,a,u?e[a]:e)})}});l.setAttribute("data-persist-fields-initialized",e(l));htmx.process(l);if(!l.hasAttribute("readonly")){L.getTriggerSpecs(l).forEach(e=>{let t=L.getInternalData(l);L.addTriggerHandler(l,e,t,(e,t)=>{if(htmx.closest(e,htmx.config.disableSelector)){return}let n=g(i,a,c);h(r,o,e=>{let t=u?m(a,e):undefined;if(JSON.stringify(n)!=JSON.stringify(f)||l.required){if(t&&!Array.isArray(t)){t[a]=u?n.flat():n}else{t=n}}p(r,t,o,s);window.dispatchEvent(new CustomEvent("htmx:persistFieldsSave",{detail:{scope:i,storage:r}}))})})})}}let j=["session","local","query","fragment","cookie","http"];let k=j.filter(e=>t(e+"Storage"));let q=k.map(e=>"[persist-fields-"+e+"]").join(",");var L;var U;var X=false;htmx.defineExtension("persist-fields",{_ext_persist_fields:true,init:function(e){L=e;U=[b,E,w,y,x,T,I,N,O]},onEvent:function(e,t){if(e==="htmx:persistFieldsClear"){let l=htmx.closest(t.detail.elt,q);if(l){let i=k.find(e=>l.hasAttribute("persist-fields-"+e));let r=l.getAttribute("persist-fields-"+i);u(l).forEach(e=>{let t=C(e);if(r==="indexed"){let e=u(l).map(C).filter(a);r=e.indexOf(t)}else if(r===""||i==="query"||i==="fragment"){r=undefined}let n=_(i,t,r);f(i,l,n)})}}else if(e==="htmx:afterProcessNode"){u(t.detail.elt).filter(e=>!e.hasAttribute("data-persist-fields-initialized")).forEach(n=>{let i=htmx.closest(n,q);if(i){let e=k.find(e=>i.hasAttribute("persist-fields-"+e));let t=i.getAttribute("persist-fields-"+e);if(t==="indexed"){let e=u(i).map(C).filter(a);t=e.indexOf(C(n))}else if(t===""||e==="query"||e==="fragment"){t=undefined}P(i,e,n,t)}})}}})})();